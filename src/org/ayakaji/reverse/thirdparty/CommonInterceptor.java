/********************************
 * AgentOne Core                *
 * Common Interceptor           *
 * Compiled By: jdk1.6.0_45_x64 *
 * Author: Hugh                 *
 ********************************/
package org.ayakaji.reverse.thirdparty;

import java.util.Enumeration;
import java.util.HashSet;
import java.util.LinkedHashMap;
import java.util.Set;
import java.util.Timer;
import java.util.UUID;
import java.util.regex.Pattern;

import javax.servlet.http.Cookie;

import org.apache.catalina.connector.Request;
import org.apache.catalina.connector.Response;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.hyperic.sigar.FileSystem;
import org.hyperic.sigar.FileSystemUsage;
import org.hyperic.sigar.NetInterfaceConfig;
import org.hyperic.sigar.NetInterfaceStat;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;

public class CommonInterceptor {

	private static final Log log = LogFactory.getLog(CommonInterceptor.class);

	static {
		log.info("AgentOne Common Interceptor Activated ...");
	}

	/**
	 * A unique transaction identification code generated from the browser and
	 * further transparently passed to the current process. This parameter does not
	 * change throughout the life of the transaction and is consistent across any
	 * layers of the transaction. The value of this parameter will be set from the
	 * inbound request interception function, that is, copy the relevant data in the
	 * incoming request header came from the previous layer. If the incoming value
	 * is null, it will be initialized, which can also be regarded as a headless
	 * transaction, which means if the sensor is not deployed on the previous layer,
	 * the headless transaction performs the topology transaction association
	 * backward with the current execution point as the entry point.
	 */
	public static InheritableThreadLocal<String> xTag = new InheritableThreadLocal<String>();

	/**
	 * The purpose of this parameter is to sort the logs generated by the same
	 * transaction in different layers. This parameter is set according to the
	 * execution of the transaction, not the fixed ID of the layer. This parameter
	 * value will be initialized in the inbound interceptor. If the incoming value
	 * from previous layer not exists, this parameter will be initialized to 0.
	 */
	public static InheritableThreadLocal<Integer> iLayer = new InheritableThreadLocal<Integer>();

	/**
	 * The order in which components are called within the same layer, and can also
	 * be thought of as the order in which the business modules are called by the
	 * execution thread and its derived threads. This parameter can be thought of as
	 * an outbound call in the general sense, such as an inbound call that can be
	 * mapped to multiple outbound calls.
	 */
	public static InheritableThreadLocal<Integer> iComp = new InheritableThreadLocal<Integer>();

	/**
	 * Get XTag
	 * 
	 * @return
	 */
	public static String getXTag() {
		return xTag.get();
	}

	/**
	 * Get Layer Number
	 * 
	 * @return
	 */
	public static Integer getLayerNum() {
		return iLayer.get();
	}

	/**
	 * Get Component Number
	 * 
	 * @return
	 */
	public static Integer getComponentNum() {
		return iComp.get();
	}

	/**
	 * This function will be called in inbound interceptor, which means the
	 * transaction has been passed to a new layer.
	 * 
	 * @return
	 */
	public static Integer nextLayer() {
		if (iLayer.get() == null)
			iLayer.set(0);
		int i = iLayer.get();
		iLayer.set(++i);
		return i;
	}

	/**
	 * This function will be called in outbound interceptor, and also in some
	 * execution point
	 * 
	 * @return
	 */
	public static Integer nextComponent() {
		if (iComp.get() == null)
			iComp.set(0);
		int i = iComp.get();
		iComp.set(++i);
		return i;
	}

	/**
	 * Get Component Number
	 */

	public static void start() {
		Timer timer = new Timer();
		timer.schedule(new OnceTask(), OnceTask.onceTaskDelaySec);
		log.info("OnceTask Started ...");
		timer.schedule(new CycleTask(), CycleTask.cycleTaskDelaySec, CycleTask.cycleTaskPeriodSec);
		log.info("CycleTask Started ...");
	}

	/**
	 * Monitored request Content-Type header
	 */
	private static final Set<String> monContTypes = new HashSet<String>() {
		private static final long serialVersionUID = -5872858239490155051L;
		{
			add("application/ueefire");
			add("application/json");
			add("text/plain");
			add("text/html");
		}
	};

	/**
	 * Monitored request headers
	 */
	private static final Set<String> monReqHdrNames = new HashSet<String>() {
		private static final long serialVersionUID = -5872858239490155051L;
		{
			add("accept");
			add("accept-encoding");
			add("Content-Type");
			add("host");
			add("referer");
			add("region");
			add("operId");
			add("x-forwarded-proto");
			add("x-forwarded-for");
			add("x-real-ip");
			add("XTag");
		}
	};

	/**
	 * Monitored response headers
	 */
	private static final Set<String> monRespHdrNames = new HashSet<String>() {
		private static final long serialVersionUID = -5872858239490155051L;
		{
			add("Content-Length");
			add("Content-Type");
		}
	};

	/**
	 * Monitored cookies
	 */
	private static final Set<String> monCookNames = new HashSet<String>() {
		private static final long serialVersionUID = -2845300377697961512L;
		{
			add("XTag");
			add("MACAddr");
			add("IPAddr");
			add("sDNSName");
			add("operId");
		}
	};

	@SuppressWarnings("unused")
	private static class FileSystemEx {
		private FileSystem fs = null;
		private FileSystemUsage fsUsage = null;

		public FileSystem getFs() {
			return fs;
		}

		public void setFs(FileSystem fs) {
			this.fs = fs;
		}

		public FileSystemUsage getFsUsage() {
			return fsUsage;
		}

		public void setFsUsage(FileSystemUsage fsUsage) {
			this.fsUsage = fsUsage;
		}
	}

	@SuppressWarnings("unused")
	private static class NetInterface {
		private String ifname = null;
		private NetInterfaceConfig ifcfg = null;
		private NetInterfaceStat ifstat = null;

		public String getIfname() {
			return ifname;
		}

		public void setIfname(String ifname) {
			this.ifname = ifname;
		}

		public NetInterfaceConfig getIfcfg() {
			return ifcfg;
		}

		public void setIfcfg(NetInterfaceConfig ifcfg) {
			this.ifcfg = ifcfg;
		}

		public NetInterfaceStat getIfstat() {
			return ifstat;
		}

		public void setIfstat(NetInterfaceStat ifstat) {
			this.ifstat = ifstat;
		}
	}

	/**
	 * Check if is integer
	 * 
	 * @param str
	 * @return
	 */
	public static boolean isInteger(String str) {
		Pattern pattern = Pattern.compile("^[-\\+]?[\\d]*$");
		return pattern.matcher(str).matches();
	}

	/**
	 * @IntercepterTarget: org.apache.catalina.connector.Request
	 * @InjectTarget: org.apache.catalina.connector.CoyoteAdapter.service()
	 * @InjectVersion: catalina.jar (tomcat 8.5.47)
	 * @IssueResolved: Request & Response Data submitted separately, for the sake of
	 *                 long transaction data can be captured in time
	 * @IssueResolved: Only collect dynamic requests, static requests captured by
	 *                 nginx
	 * @IssueResolved: Support for getting XTag from request headers and cookies,
	 *                 the former is preferred
	 * @param request
	 * @return
	 */
	public static final String getRequestInfo(final Request request) {
		boolean bCap = false;
		for (String contTyp : monContTypes) {
			if (request.getContentType() != null && request.getContentType().indexOf(contTyp) != -1) {
				bCap = true;
				break;
			}
			if (request.getHeader("accept").indexOf(contTyp) != -1) {
				bCap = true;
				break;
			}
		}
		if (!bCap)
			return null;
		JSONObject jsonReq = new JSONObject(new LinkedHashMap<String, Object>() {
			private static final long serialVersionUID = -1845384774977215315L;
			{
				put("method", request.getMethod()); // HTTP Method
				put("uri", request.getRequestURI()); // URI
				put("reqStartTime", request.getCoyoteRequest().getStartTime()); // Request Really Start Time
				put("parameter", new LinkedHashMap<String, Object>() { // Request Parameters
					private static final long serialVersionUID = 3176226952747839590L;
					{
						Enumeration<String> paraNames = request.getParameterNames();
						while (paraNames != null && paraNames.hasMoreElements()) {
							String paraName = paraNames.nextElement();
							put(paraName, request.getParameter(paraName));
						}
					}
				});
				put("remoteAddr", request.getRemoteAddr()); // Source IP
				put("remotePort", request.getRemotePort()); // Source Port
				put("scheme", request.getScheme()); // scheme
				put("localAddr", request.getLocalAddr()); // Destination IP
				put("localPort", request.getLocalPort()); // Destination Port
				put("localHost", request.getLocalName()); // Destination Hostname
				put("contentType", request.getContentType()); // Content Type
				put("header", new LinkedHashMap<String, Object>() { // Request Headers
					private static final long serialVersionUID = 8174872950110727686L;
					{
						for (String hdrName : monReqHdrNames) {
							put(hdrName, request.getHeader(hdrName));
						}
						String s = request.getHeader("XTag");
						if (s != null && !s.equals("")) { // If exists then passed backwards
							xTag.set(s);
						} else { // If not, then initialize
							xTag.set(UUID.randomUUID().toString());
						}
						s = request.getHeader("XLayer");
						if (s != null && !s.equals("") && isInteger(s)) { // If exists then passed backwards
							iLayer.set(Integer.parseInt(s));
						} else { // If not, then initialize
							iLayer.set(0);
						}
					}
				});
				put("cookies", new LinkedHashMap<String, Object>() { // Cookies
					private static final long serialVersionUID = 3816290971458672124L;
					{
						// If found the XTag from the request header and set it to the thread local
						// variable.
						Cookie[] cooks = request.getCookies();
						if (cooks != null && cooks.length > 0) {
							for (final Cookie cook : cooks) {
								if (monCookNames.contains(cook.getName())) {
									put(cook.getName(), cook.getValue());
									if (cook.getName().equals("XTag")
											&& (xTag.get() == null || xTag.get().equals(""))) { // XTag passed backwards
										xTag.set(cook.getValue());
									}
									if (cook.getName().equals("XLayer") && iLayer.get() == null) { // Set current layer number
										if (isInteger(cook.getValue())) // Illegal Data
											iLayer.set(Integer.parseInt(cook.getValue()));
										else
											iLayer.set(0);
									}
								}
							}
						}
					}
				});
			}
		});
		return JSON.toJSONString(jsonReq, true);
	}

	/**
	 * org.apache.catalina.connector.Response Intercepter
	 * 
	 * @param response
	 * @return
	 */
	public static final String getResponseInfo(final Response response) {
		boolean bCap = false;
		for (String contTyp : monContTypes) {
			if (response.getContentType() != null && response.getContentType().indexOf(contTyp) != -1) {
				bCap = true;
				break;
			}
			if (response.getHeader("Content-Type") != null
					&& response.getHeader("Content-Type").indexOf(contTyp) != -1) {
				bCap = true;
				break;
			}
		}
		if (!bCap)
			return null;
		JSONObject jsonResp = new JSONObject(new LinkedHashMap<String, Object>() {
			private static final long serialVersionUID = -2235465307548276090L;
			{
				put("characterEncoding", response.getCharacterEncoding());
				put("contentLength", response.getContentLength());
				put("contentType", response.getContentType());
				put("status", response.getStatus());
				put("timeLossMills",
						(System.currentTimeMillis() - response.getRequest().getCoyoteRequest().getStartTime())
								/ 1000.0);
				put("header", new LinkedHashMap<String, Object>() { // Response Headers
					private static final long serialVersionUID = -6979907342590178552L;
					{
						for (String hdrName : monRespHdrNames) {
							put(hdrName, response.getHeader(hdrName));
						}
					}
				});
				put("message", response.getMessage());
			}
		});
		return JSON.toJSONString(jsonResp, true);
	}

	public static void main(String[] args) throws ClassNotFoundException {
	}
}
